<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Config Wifi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    #snackbar {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1100;
      left: 50%;
      top: 30px;
      font-size: 17px;
    }

    /* CSS cho snackbar khi hi·ªÉn th·ªã */
    #snackbar.show {
      visibility: visible;
    }

    .c,
    body {
      text-align: center;
      font-family: verdana;
      width: 100%;
    }

    div,
    input,
    select {
      padding: 5px;
      font-size: 1.5rem;
      margin: 5px 0;
      box-sizing: border-box;
    }

    input,
    button,
    select,
    .msg {
      border-radius: .3rem;
      width: 100%;
    }

    input[type=radio],
    input[type=checkbox] {
      width: auto
    }

    button,
    input[type='button'],
    input[type='submit'] {
      cursor: pointer;
      border: 0;
      background-color: #1fa3ec;
      color: #fff;
      line-height: 2.4rem;
      font-size: 1.2rem;
      width: 100%;
    }

    input[type='file'] {
      border: 1px solid #1fa3ec
    }

    .wrap {
      text-align: left;
      display: inline-block;
      width: 100%;
      min-width: 300px;
      max-width: 500px;
    }

    h3 {
      background-color: #cce0ff;
      width: 100%;
      border-radius: .3rem;
    }

    a {
      color: #000;
      font-weight: 700;
      text-decoration: none;
    }

    a:hover {
      color: #1fa3ec;
      text-decoration: underline;
    }

    .q {
      height: 16px;
      margin: 0;
      padding: 0 5px;
      text-align: right;
      min-width: 38px;
      float: right;
    }

    .q.q-0:after {
      background-position-x: 0;
    }

    .q.q-1:after {
      background-position-x: -16px;
    }

    .q.q-2:after {
      background-position-x: -32px;
    }

    .q.q-3:after {
      background-position-x: -48px;
    }

    .q.q-4:after {
      background-position-x: -64px;
    }

    .q.l:before {
      background-position-x: -80px;
      padding-right: 5px;
    }

    .ql .q {
      float: left;
    }

    .q:after,
    .q:before {
      content: '';
      width: 16px;
      height: 16px;
      display: inline-block;
      background-repeat: no-repeat;
      background-position: 16px 0;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAQCAMAAADeZIrLAAAAJFBMVEX///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADHJj5lAAAAC3RSTlMAIjN3iJmqu8zd7vF8pzcAAABsSURBVHja7Y1BCsAwCASNSVo3/v+/BUEiXnIoXkoX5jAQMxTHzK9cVSnvDxwD8bFx8PhZ9q8FmghXBhqA1faxk92PsxvRc2CCCFdhQCbRkLoAQ3q/wWUBqG35ZxtVzW4Ed6LngPyBU2CobdIDQ5oPWI5nCUwAAAAASUVORK5CYII=');
    }

    #refresh_icon {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-block;
      float: right;
      margin-left: 10px;
      cursor: pointer;
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"%3E%3Cpath d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6a6 6 0 0 1-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" fill="%23333" /%3E%3C/svg%3E');
      background-size: 100% 100%;
      background-repeat: no-repeat;
      margin: 2px 10px 2px 10px;
    }

    #loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #333;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      float: right;
      margin-left: 10px;
      margin-top: 5px;
      /* Thi·∫øt l·∫≠p kho·∫£ng c√°ch tr√™n, ph·∫£i, d∆∞·ªõi, v√† tr√°i */
      margin: 2px 10px 2px 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>

</head>

<body class="{c}">
  <div id="snackbar"></div> <!-- th√¥ng b√°o -->
  <nav style="overflow:hidden; background-color:#f2f2f2; position:fixed; left:0px; top:0px; z-index:1000; width:100%;">
    <h2>Thi·∫øt l·∫≠p wifi</h2>
  </nav>
  <br><br><br>


  <div class="wrap container">
    <br><br><br>


    <div id="wifi_CMD_hear"></div>

    <br>
    <h3>Wifi<a id="loader_html"></a></h3>

    <div id="wifi_scan_hear"></div>

    <br><br>
    <form id="wifiForm">
      <label for="s">T√™n Wifi</label>
      <input id="s" name="ssid" maxlength="32" autocorrect="off" autocapitalize="none" placeholder="T√™n Wifi">
      <br>
      <table style="width:100%;">
        <td style="width:90%;"><label for="p">M·∫≠t kh·∫©u</label></td>
        <td style="width:10%;"><a id="hide_icon" onclick="hide_f()"></a></td>
      </table>

      <input id="p" name="password" maxlength="64" type="password" placeholder="********">
      <br><br>
      <button type="submit">L∆∞u</button>
    </form>
    <br>
    <button onclick="fetchWifiScanData()">L√†m m·ªõi</button>
    <br><br>
    <a href="/"><button>V·ªÅ trang ch·ªß</button></a>
  </div>
  <br><br><br>


  <script>

    function getMillis() {
      let d = new Date();
      let n = ((d.getHours() * 60 + d.getMinutes()) * 60 + d.getSeconds()) * 1000 + d.getMilliseconds();
      return n;
    }

    window.onload = function () {  // G·ªçi h√†m khi trang ƒë∆∞·ª£c t·∫£i
      fetchWifiScanData();
    };
    function fetchWifiScanData() {                                        // Function ƒë·ªÉ g·ªçi API scan wifi v√† x·ª≠ l√Ω d·ªØ li·ªáu d·∫°ng HTML
      document.getElementById('loader_html').innerHTML = "<span id='loader'></span>";        // bi·ªÉu t∆∞·ª£ng load

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          try {
            let state = JSON.parse(this.responseText);                    // Chuy·ªÉn ƒë·ªïi this.responseText t·ª´ chu·ªói JSON sang ƒë·ªëi t∆∞·ª£ng JSON
            let CMD = "";
            let Wifi_connect_info = "";                                   // bi·∫øn ƒë·ªám l∆∞u th√¥ng tin k·∫øt n·ªëi wifi

            if (state['client_ID'] == state['softAPIP']) {                                                      // n·∫øu IP thi·∫øt b·ªã k·∫øt n·ªëi tr√πng v·ªõi softAPIP th√¥ng b√°o m·∫°ng ƒëang k·∫øt n·ªëi
              Wifi_connect_info += "<p>B·∫°n ƒëang k·∫øt n·ªëi th√¥ng qua ƒëi·ªÉm ph√°t: " + state['softAPSSID'] + "</p>";  // th√¥ng b√°o k·∫øt n·ªëi qua softAP
            } else {
              Wifi_connect_info += "<p>B·∫°n ƒëang k·∫øt n·ªëi th√¥ng qua m·∫°ng wifi: " + state['SSID'] + "</p>";        // th√¥ng b√°o k·∫øt n·ªëi qua m·∫°ng wifi c·ª•c b·ªô
            }
            Wifi_connect_info += "<br>";                                  // kho·∫£ng c√°ch
            Wifi_connect_info += "<h3>C&#7845;u h&igrave;nh SoftAP</h3>"; //
            Wifi_connect_info += "<table>";                               //
            Wifi_connect_info += "<tr>";                                  //
            Wifi_connect_info += "<td>SSID:</td> ";                       //
            Wifi_connect_info += "<td>" + state['softAPSSID'] + "</td>";  //
            Wifi_connect_info += "</tr>";                                 //
            Wifi_connect_info += "<tr>";                                  //
            Wifi_connect_info += "<td>IP:</td>";                          //
            Wifi_connect_info += "<td><a href='http://" + state['softAPIP'] + "'>" + state['softAPIP'] + "</a></td>"; //
            Wifi_connect_info += "</tr>";                                 //
            Wifi_connect_info += "</table>";                              //

            Wifi_connect_info += "<br>";                                  //

            Wifi_connect_info += "<h3>C&#7845;u h&igrave;nh WLAN</h3>";   //
            Wifi_connect_info += "<table>";                               //
            Wifi_connect_info += "<tr>";                                  //
            Wifi_connect_info += "<td>SSID:</td> ";                       //
            Wifi_connect_info += "<td>" + state['SSID'] + "</td>";        //
            Wifi_connect_info += "</tr>";                                 //
            Wifi_connect_info += "<tr>";                                  //
            Wifi_connect_info += "<td>IP:</td> ";                         //
            Wifi_connect_info += "<td><a href='http://" + state['localIP'] + "'>" + state['localIP'] + "</a></td>"; //
            Wifi_connect_info += "</tr>";                                 //
            Wifi_connect_info += "</table>";                              //

            Wifi_connect_info += "<br>";                                  //

            CMD += "\r\n";                                                //
            CMD += Wifi_connect_info;                                     //


            let n = state['num_wifi_scan'];                               // t√¨m c√°c wifi l√¢n c·∫≠n
            let re = "";                                                  // bi·∫øn l∆∞u html hi·ªÉn th·ªã wifi

            if (n == 0) {                                                 // n·∫øu kh√¥ng c√≥ wifi l√¢n c·∫≠n
              re += "<div>No networks found</div>";                       //
            }
            else {                                                        // n·∫øu c√≥ wifi l√¢n c·∫≠n

              let rank = [];                                              // bi·∫øn s·∫Øp s·∫øp wifi theo c∆∞·ªùng ƒë·ªô s√≥ng
              for (let i = 0; i < n; ++i) rank[i] = i;                    // t·∫°o gi√° tr·ªã ban ƒë·∫ßu t·ª´ 0 t·ªõi n

              for (let i = 0; i < n; ++i) {                               // ch·∫°y h·∫øt m·∫£ng gi√° tr·ªã
                for (let j = i; j < n; ++j) {                             // ch·∫°y t·ª´ i t·ªõi h·∫øt m·∫£ng gi√° tr·ªã
                  if (state[`RSSI${rank[i]}`] < state[`RSSI${rank[j]}`]) {// n·∫øu gi√° tr·ªã c∆∞·ªùng ƒë·ªô s√≥ng c·ªßa i kh√¥ng ph·∫£i l√† l·ªõn nh·∫•t
                    let buf = rank[i];                                    // bi·∫øn ƒë·ªám ƒë·ªÉ d·∫£o gi√° tr·ªã
                    rank[i] = rank[j];                                    // ƒë·∫£o gi√° tr·ªã
                    rank[j] = buf;                                        // ƒë·∫£o gi√° tr·ªã
                  }                                                       //
                }                                                         //
              }                                                           //

              for (let i = 0; i < n; ++i) {                               // ch·∫°y h·∫øt c√°c m·∫°ng wifi
                re += "<div>";                                            //

                let hasKeyIcon = false;                                   // ki·ªÉm tra c√≥ ƒë∆∞·ª£c l∆∞u kh√¥ng
                for (let j = 1; j <= state['num_wifi']; j++) {            // ch·∫°y ki·ªÉm tra trong d·ªØ li·ªáu wifi ƒë√£ l∆∞u
                  if (state[`ssid${j}`] === state[`SSID${rank[i]}`]) {    // n·∫øu ƒë√£ l∆∞u
                    hasKeyIcon = true;                                    // ƒë√°nh d·∫•u l√† c√≥ l∆∞u
                    break;                                                // tho√°t for
                  }
                }

                re += "<a onclick=\"c(this)\" data-ssid=\"" + state[`SSID${rank[i]}`] + "\">" + state[`SSID${rank[i]}`];
                if (hasKeyIcon) re += " üîë";                              // Add key icon
                re += "</a>";

                re += "<div role=\"img\" class=\"q ";                     // l·ªõp q bi·ªÉu t∆∞·ª£ng m·ª©c wifi
                if (state[`RSSI${rank[i]}`] > -60) re += "q-4";           // t√≠n hi·ªáu m·∫°nh nh·∫•t
                else if (state[`RSSI${rank[i]}`] > -70) re += "q-3";      // t√≠n hi·ªáu y·∫øu h∆°n
                else if (state[`RSSI${rank[i]}`] > -80) re += "q-2";      // t√≠n hi·ªáu y·∫øu h∆°n
                else if (state[`RSSI${rank[i]}`] > -90) re += "q-1";      // t√≠n hi·ªáu y·∫øu h∆°n
                else re += "q-0";                                         // t√≠n hi·ªáu y·∫øu nh·∫•t
                if (state[`encryptionType${rank[i]}`]) re += " l";        // n·∫øu c√≥ b·∫£o m·∫≠t th√™m ·ªï kh√≥a
                re += "\"></div>";                                        //
                re += "</div>";                                           //
              }                                                           //
            }                                                             //

            document.getElementById('wifi_CMD_hear').innerHTML = CMD;     // hi·ªÉn th·ªã
            document.getElementById('wifi_scan_hear').innerHTML = re;     // hi·ªÉn th·ªã      
            document.getElementById('loader_html').innerHTML = "<span id='refresh_icon' onclick='fetchWifiScanData()'></span>"; // Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng loader th√†nh bi·ªÉu t∆∞·ª£ng refresh
          } catch (e) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi this.responseText th√†nh JSON:", e);
            document.getElementById('wifi_scan_hear').innerHTML = "<div>L·ªói khi l·∫•y d·ªØ li·ªáu m·∫°ng WiFi.</div>";
          }

        }
        // setTimeout(fetchWifiScanData, 60000);
      };
      xhttp.open("GET", "/_WIFI_SCAN_", true);
      xhttp.send();
    }

    document.getElementById('wifiForm').addEventListener('submit', function (e) {
      e.preventDefault();                                                 // Ng·ª´ng l√†m m·ªõi trang khi submit form

      const ssid = document.getElementById('s').value;                    // L·∫•y d·ªØ li·ªáu t·ª´ form
      const password = document.getElementById('p').value;

      var xhttp = new XMLHttpRequest();                                   // T·∫°o ƒë·ªëi t∆∞·ª£ng XMLHttpRequest
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) {
            showSnackbar("L∆∞u th√†nh c√¥ng!");
          } else {
            showSnackbar("L·ªói khi l∆∞u!");
          }
          setTimeout(fetchWifiScanData, 10000); // l√†m m·ªõi d·ªØ li·ªáu wifi sau 10s
        }
      };

      xhttp.open("PUT", "/wifisave", true);// G·ª≠i y√™u c·∫ßu POST t·ªõi server
      xhttp.setRequestHeader("Content-Type", "application/json");

      var data = JSON.stringify({ "ssid": ssid, "password": password });// G·ª≠i d·ªØ li·ªáu d∆∞·ªõi d·∫°ng JSON
      xhttp.send(data);
    });

    function showSnackbar(message) {// Function ƒë·ªÉ hi·ªÉn th·ªã snackbar
      const snackbar = document.getElementById("snackbar");
      snackbar.innerText = message;
      snackbar.className = "show";
      setTimeout(() => { snackbar.className = snackbar.className.replace("show", ""); }, 3000); // Th·ªùi gian hi·ªÉn th·ªã snackbar l√† 3 gi√¢y
    }

    function c(l) {
      document.getElementById('s').value = l.getAttribute('data-ssid') || l.innerText || l.textContent;
      p = l.nextElementSibling.classList.contains('l');
      document.getElementById('p').disabled = !p;
      if (p) document.getElementById('p').focus();
    }

    hide_f();
    var password_visibility = 0;
    function hide_f() {
      if (password_visibility == 0) {
        password_visibility = 1;
        document.getElementById("hide_icon").innerHTML = "<img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAU1JREFUSEvd1b1KXkEQxvHfewcWQkilTWJlCAStkyswjQFB0aRIraixVEu/SGoLP1AIxEavQGtFEFPFNLESwcI7UEbmwPqiBIRt3GrP7Ozz331md09L5daqrO/5A7oxhi68Qk9a+gd/cY4N/HvM6scseovRFO/4T52uE7KJk/bchwCD+FUkrmIbl7jI+Eu8wDC+FrmfsFNC2gGl+E+s4BgjKVRaFOAtvMMkhlL4HqQEDGA3k35gIvsl9CpjnQ+Ifcd4xj9iL/ol4BB9WMZ0JvbiFGdYwFrGv2AGr/EGvzO+hCkcob8EfEuBEGpsiPE4QetpVUwsWywkrPmcRW7G4oQFOBaw2OzgJkc/4KBQmcMs2uOR8h77mEfkNa2J322gAVTfQdCq1iAA1U9RQKreg6ZIVW9yA6n6FpVnvdpr2nannv75/P9oT/cmZ1a36BZnD2UZnSTnLwAAAABJRU5ErkJggg=='>";
        document.getElementById("p").type = "text";
      } else {
        password_visibility = 0;
        document.getElementById("hide_icon").innerHTML = "<img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAehJREFUSEu11buvTUEUx/HP0RMNohBELhoihBZ/AYorJMSjUCmIV4nSKyQqN/EKIaGh06ElEqHySFCJaCQ6DVmy5mTuZO9T7TvJSfbZs2d916zfb82MzPEYzXF8NWAlvgwNLIAFeIqXODckpACm8SgDn68gG7ANWzGFZfiDD/iEb7iDr31J1SXqg1zGiQm7+pWQu3jbfteK3Ac5gplcPB9LsQT7EHNl7MbjGjIJEN/V5YoSRgI/s0QBvIdNucO9GXgWZFKJznZocgm7sKoj2FUcy/c70zRjm8Z232FxlfUOPOmAxKvDuJlz6/E+nyOBk3iNLfGu7KBMvMD2qobhoOc9kBtZ/0MpclkWDluNM7hYAH9zNoIHpIzoiVKqVpNiiFqn+KZOalQAp3EBH7GmAhzE7cZ6dcBrCJvWzfkGG0upa5FfYTPC96cy6LrUprV3m3W74yjT2lqDeK5FjcyO56q6N2pQC7mF0CPG2KqT+uAhriC2vD8FjfItqihdfdLbB2Vdm3E01H38wHf8RjTVgw53xdqJnVwgccgdQIi8sBWg43+fJrPug644KxKyPE/TKNG8PEk/I35dHT+ONcSNVize9sl/yBCAiHMU1zs0GQwQscv5FHdCOCkupEEBEW8PnmV3D1qiXqP9A9u8bxkywqQAAAAAAElFTkSuQmCC'>";
        document.getElementById("p").type = "password";
      }
    }

  </script>
</body>

</html>